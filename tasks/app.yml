---
- name: Create app schema
  community.mysql.mysql_db: 
    name: app
    state: present
    login_user: root
    login_password: "{{ mariadb.root_password }}"    
  notify: Import app schema

- name: Create app db user
  community.mysql.mysql_user:
    name: "{{ app.database.user }}"
    password: "{{ app.database.password }}"
    priv: 'app.*:ALL,GRANT'
    state: present
    login_user: root
    login_password: "{{ mariadb.root_password }}"

- name: Create app directory
  ansible.bultin.file:
    dest: "{{ system.directories.web_content }}app-web"
    state: directory

- name: create app index
  ansible.bultin.copy:
    dest: "{{ system.directories.web_content }}app-web/index.php"
    content: |
      <?php
      phpinfo();
      ?>

  ansible.builtin.git:
    repo: git@github.com:max171/app-classic-web.git
    dest: "{{ app.directories.web }}"
  become: true
  become_user: "{{ system.user }}"
  
- name: Create symlink from /srv/git to /srv/http
  ansible.builtin.file:
    src: "{{ app.directories.web }}"
    dest: "{{ system.directories.web_content }}app-web"
    owner: "{{ system.user }}"
    group: "{{ system.group }}"
    state: link
    follow: false

- name: Add nginx app server block
  ansible.builtin.template:
    src: etc/nginx/conf.d/app.conf.j2
    dest: "{{ nginx.directories.conf_d }}app.conf"
  notify: Reload nginx